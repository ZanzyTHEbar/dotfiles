#!/bin/bash
# A command wrapper for screen recording.

# --- Dependencies Check ---
for cmd in wl-screenrec slurp; do
    if ! command -v "$cmd" &> /dev/null; then
        echo "Error: Required command '$cmd' not found." >&2
        exit 1
    fi
done

# --- Configuration ---
[[ -f ~/.config/user-dirs.dirs ]] && source ~/.config/user-dirs.dirs
OUTPUT_DIR="${XDG_VIDEOS_DIR:-$HOME/Videos}/Screen Records"
mkdir -p "$OUTPUT_DIR"

# --- Main Logic ---
screenrecording() {
  filename="$OUTPUT_DIR/screenrecord-$(date +'%Y-%m-%d_%H-%M-%S').mp4"
  echo "Screen recording starting... Output file: $filename"
  sleep 1
  wl-screenrec -f "$filename" --ffmpeg-encoder-options="-c:v libx264 -crf 23 -preset medium -movflags +faststart" "$@"
}

if pgrep -x wl-screenrec >/dev/null; then
  pkill -x wl-screenrec
  echo "Screen recording stopped. File saved in $OUTPUT_DIR"
elif [[ "$1" == "output" ]]; then
  screenrecording
else
  region=$(slurp) || exit 1
  screenrecording -g "$region"
fi
